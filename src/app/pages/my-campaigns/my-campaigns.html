<!-- Loading State -->
<div class="loading-container" *ngIf="isLoading()">
  <div class="loading-content">
    <div class="loading-spinner">
      <i class="pi pi-spin pi-spinner"></i>
    </div>
    <h2 class="loading-text">Carregando suas campanhas...</h2>
    <p class="loading-subtitle">Buscando suas aventuras salvas</p>
  </div>
</div>

<!-- Main Content -->
<div class="my-campaigns-container" *ngIf="!isLoading()">
  <!-- Header -->
  <div class="campaigns-header">
    <div class="header-content">
      <div class="header-nav">
        <p-button
          icon="pi pi-arrow-left"
          label="Voltar"
          (onClick)="goBack()"
          severity="secondary"
          [text]="true"
        ></p-button>

        <div class="header-title-section">
          <h1 class="header-title">Minhas Campanhas</h1>
          <p class="header-subtitle">Suas aventuras e progresso</p>
        </div>

        <div class="header-actions">
          <p-button
            icon="pi pi-refresh"
            (onClick)="refreshCampaigns()"
            severity="secondary"
            size="small"
            [text]="true"
            pTooltip="Atualizar campanhas"
            tooltipPosition="bottom"
            [disabled]="isLoading()"
          ></p-button>
          <p-button
            icon="pi pi-plus"
            label="Nova Campanha"
            (onClick)="createNewCampaign()"
            severity="success"
            size="small"
          ></p-button>
        </div>
      </div>
    </div>
  </div>

  <!-- Campaigns Grid -->
  <div class="campaigns-grid" *ngIf="campaigns().length > 0">
    <div
      class="campaign-card-wrapper"
      *ngFor="let campaign of campaigns(); let i = index"
    >
      <div class="campaign-card">
        <div class="campaign-header-card">
          <div class="campaign-status">
            <p-tag
              [value]="getStatusLabel(campaign.status)"
              [severity]="getStatusSeverity(campaign.status)"
              class="status-tag"
            ></p-tag>
          </div>
          <h3 class="campaign-title">{{ campaign.campaignName }}</h3>
        </div>

        <div class="campaign-description">
          <p>{{ campaign.description }}</p>
        </div>

        <div class="campaign-progress">
          <div class="progress-info">
            <span class="progress-label">Progresso</span>
            <span class="progress-percentage" *ngIf="campaign.progress">{{ getProgressPercentage(campaign.progress) }}%</span>
            <span class="progress-percentage" *ngIf="!campaign.progress || !isCampaignStarted(campaign)">0%</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              [style.width.%]="campaign.progress ? getProgressPercentage(campaign.progress) : 0"
              [class.not-started]="!isCampaignStarted(campaign)"
            ></div>
          </div>
          <div class="progress-details">
            <small *ngIf="campaign.progress && isCampaignStarted(campaign)">
              Lance {{ campaign.progress.time || 0 }} de 10 | Nível {{ campaign.progress.level || 1 }}
            </small>
            <small *ngIf="!isCampaignStarted(campaign)">Campanha não iniciada</small>
            <small *ngIf="campaign.progress && isCampaignStarted(campaign) && campaign.progress.currentMission">
              {{ campaign.progress.currentMission }}
            </small>
          </div>
        </div>

        <div class="campaign-meta">
          <div class="meta-item" *ngIf="campaign.startDate">
            <i class="pi pi-calendar"></i>
            <span>Iniciada em {{ formatDate(campaign.startDate) }}</span>
          </div>
          <div class="meta-item" *ngIf="!campaign.startDate">
            <i class="pi pi-calendar"></i>
            <span>Aguardando início</span>
          </div>
          <div class="meta-item" *ngIf="campaign.lastPlayedDate">
            <i class="pi pi-clock"></i>
            <span>Última vez: {{ formatDate(campaign.lastPlayedDate) }}</span>
          </div>
        </div>

        <!-- Placar da Partida -->
        <div class="campaign-score" *ngIf="campaign.progress && isCampaignStarted(campaign)">
          <div class="score-header">
            <i class="pi pi-flag"></i>
            <span>Placar Atual</span>
          </div>
          <div class="score-display">
            <div class="score-team player">
              <span class="team-label">Você</span>
              <span class="score-value">{{ campaign.progress.score || 0 }}</span>
            </div>
            <div class="score-separator">x</div>
            <div class="score-team opponent">
              <span class="team-label">Adversário</span>
              <span class="score-value">{{ campaign.progress.opponent_score || 0 }}</span>
            </div>
          </div>
        </div>
        <div class="campaign-actions">
          <p-button
            [label]="getButtonText(campaign)"
            [icon]="getButtonIcon(campaign)"
            (onClick)="selectCampaign(campaign)"
            [severity]="getButtonSeverity(campaign)"
            styleClass="select-campaign-button"
          ></p-button>
          <p-button
            label="Deletar"
            icon="pi pi-trash"
            (onClick)="deleteCampaign(campaign)"
            severity="danger"
            size="small"
            [outlined]="true"
            styleClass="delete-campaign-button"
          ></p-button>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="campaigns().length === 0 && !isLoading()">
    <p-card styleClass="empty-card">
      <div class="empty-content">
        <i class="pi pi-inbox empty-icon"></i>
        <h3>Nenhuma campanha encontrada</h3>
        <p>Você ainda não possui nenhuma campanha. Crie sua primeira aventura!</p>
        <p-button
          label="Criar Nova Campanha"
          icon="pi pi-plus"
          (onClick)="createNewCampaign()"
          severity="success"
        ></p-button>
      </div>
    </p-card>
  </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<p-dialog
  [(visible)]="showDeleteModal"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="delete-confirmation-modal"
  header="Confirmar Exclusão"
  [style]="{ width: '400px' }"
>
  <div class="modal-content" *ngIf="campaignToDelete()">
    <div class="modal-icon">
      <i class="pi pi-exclamation-triangle"></i>
    </div>

    <div class="modal-message">
      <h4>Tem certeza que deseja deletar esta campanha?</h4>
      <p>
        <strong>{{ campaignToDelete()?.campaignName }}</strong>
      </p>
      <p class="warning-text">
        Esta ação não pode ser desfeita. Todo o progresso será perdido permanentemente.
      </p>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="modal-actions">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        (onClick)="closeDeleteModal()"
        severity="secondary"
        [outlined]="true"
        styleClass="modal-cancel-btn"
      ></p-button>
      <p-button
        label="Deletar"
        icon="pi pi-trash"
        (onClick)="confirmDeleteCampaign()"
        severity="danger"
        styleClass="modal-confirm-btn"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de Resumo da Campanha -->
<p-dialog
  [(visible)]="showSummaryModal"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="campaign-summary-modal"
  header="Resumo da Campanha"
  [style]="{ width: '500px' }"
>
  <div class="summary-content" *ngIf="campaignToReview()">
    <div class="campaign-header-summary">
      <h3>{{ campaignToReview()?.campaignName }}</h3>
      <p class="campaign-desc">{{ campaignToReview()?.description }}</p>
    </div>

    <div class="result-banner" [ngClass]="getCampaignResult(campaignToReview()!).severity">
      <i class="pi" [ngClass]="{
        'pi-trophy': getCampaignResult(campaignToReview()!).result === 'Vitória',
        'pi-times-circle': getCampaignResult(campaignToReview()!).result === 'Derrota',
        'pi-minus-circle': getCampaignResult(campaignToReview()!).result === 'Empate'
      }"></i>
      <span class="result-text">{{ getCampaignResult(campaignToReview()!).result }}</span>
    </div>

    <div class="summary-stats">
      <div class="stat-group">
        <div class="stat-item">
          <i class="pi pi-flag stat-icon"></i>
          <div class="stat-content">
            <span class="stat-label">Placar Final</span>
            <span class="stat-value">{{ campaignToReview()?.progress?.score || 0 }} x {{ campaignToReview()?.progress?.opponent_score || 0 }}</span>
          </div>
        </div>

        <div class="stat-item">
          <i class="pi pi-clock stat-icon"></i>
          <div class="stat-content">
            <span class="stat-label">Lances Jogados</span>
            <span class="stat-value">{{ campaignToReview()?.progress?.time || 0 }}/10</span>
          </div>
        </div>

        <div class="stat-item" *ngIf="campaignToReview()?.progress?.gameContext">
          <i class="pi pi-map-marker stat-icon"></i>
          <div class="stat-content">
            <span class="stat-label">Contexto Final</span>
            <span class="stat-value">{{ campaignToReview()?.progress?.gameContext }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="campaign-dates">
      <div class="date-item" *ngIf="campaignToReview()?.startDate">
        <i class="pi pi-calendar"></i>
        <span>Iniciada: {{ formatDate(campaignToReview()!.startDate!) }}</span>
      </div>
      <div class="date-item" *ngIf="campaignToReview()?.lastPlayedDate">
        <i class="pi pi-clock"></i>
        <span>Finalizada: {{ formatDate(campaignToReview()!.lastPlayedDate!) }}</span>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="summary-actions">
      <p-button
        label="Fechar"
        icon="pi pi-times"
        (onClick)="closeSummaryModal()"
        severity="secondary"
        styleClass="summary-close-btn"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Toast Messages -->
<p-toast position="top-right"></p-toast>
